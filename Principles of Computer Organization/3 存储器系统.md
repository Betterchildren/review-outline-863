## 存储器系统
**掌握存储系统的分类、分级结构与主存储器的技术指标，了解 SRAM、DRAM、EPROM、闪速存储器、相联存储器的工作原理，掌握 Cache 存储器、虚拟存储器的功能和基本工作原理。**

### 存储器概述
#### 按存储介质分类
* 半导体存储器：易失。按材料不同还可分为双极型（TTL）半导体存储器和 MOS 半导体存储器。
* 磁表面存储器：非易失。在金属或塑料基体的表面涂一层磁性材料作为记录介质，用磁头在磁层进行读/写操作。
* 磁芯存储器：非易失。硬磁材料做成环状元件，磁芯中穿有驱动线和读出线，目前已几乎不被采用。
* 光盘存储器：非易失。用激光在磁光材料上进行读/写操作。

#### 按存取方式分类
* 随机存储器（Random Access Memory, RAM）：一种可读/写存储器，存储器的任何一个存储单元的内容都可以随机存取，而且存取时间与存储单元的物理位置无关。主存都采用这种随机存储器。可分为静态 RAM和动态 RAM。
* 只读存储器（Random Access Memory, ROM）：只能对存储的内容读出，而不能写入。
* 串行访问存储器：对存储单元进行读/写操作时，需按其物理位置的先后顺序寻找地址。

#### 按在计算机中的作用分类
* 主存储器（主存）：可以和 CPU 直接交换信息。有 RAM 和 ROM。
* 辅助存储器（辅存）：存放当前暂时不用的程序和数据。有磁盘、磁带、光盘。
* 缓冲存储器（缓存）：用在两个速度不同的部件之中，起到缓冲作用。

### 存储器的层次化结构
寄存器、缓存、主存、磁盘、光盘、磁带，从左向右速度依次变慢，容量依次变大，每位价格依次降低。
* 缓存—主存层次：解决 CPU 和主存速度不匹配的问题。主存可直接与 CPU、缓存、辅存交换信息。
* 主存—辅存层次：解决存储系统的容量问题。发展过程中逐渐形成了虚拟存储系统。

### 半导体随机存取存储器
存储芯片通过地址总线、数据总线和控制总线与外部连接。地址线是单向输入的，数据线是双向的，控制线主要有读/写控制线与片选线两种。  
译码驱动方式有线选法和重合法两种。

#### SRAM 存储器
静态 RAM（Static RAM, SRAM）用触发器工作原理存储信息。

#### DRAM 存储器
动态 RAM（Dynamic RAM, DRAM）靠电容存储电荷的原理来寄存信息。必须在2 ms 内对所有存储单元恢复一次原状态，这个过程称为再生或刷新。比 SRAM 集成度更高、功耗更低。  
刷新过程实际上是先将原存信息读出，再由刷新放大器形成原信息并重新写入的再生过程。上述2 ms 称为再生周期或刷新周期。
* 集中刷新：对全部存储单元集中一段时间进行逐行刷新，此刻必须停止读/写操作。刷新的时间称为“死时间”或“死区”，所占比率称为“死时间率”。
* 分散刷新：对每行存储单元的刷新分散到每个存取周期内完成。会使存取周期变长，整个系统速度降低。
* 异步刷新：在2 ms 内对所有行各刷新一边，每次只停一行的时间。还可以将这段时间安排在 CPU 的译码阶段。

#### 只读存储器
1. 掩模 ROM（Masked ROM, MROM）：行列选择线交叉处有 MOS 管为1，没有为0。
2. 可编程 ROM（Programmable ROM, PROM）：行列选择线交叉处有熔丝，编程时可选择是否烧掉。读取时熔丝未断为1，断为0。
3. 可擦除可编程 ROM（Erasable Programmable ROM, EPROM）：采用 N 型沟道浮动栅 MOS 电路，可用紫外线进行全部擦洗。
4. 用电可擦除可编程 ROM（Electrically Erasable Programmable ROM, EEPROM）：用电气方法可将存储内容擦除重写，甚至可以局部擦写。

#### Flash 存储器
可擦写非易失性存储器。既有 EPROM 的价格便宜、集成度高的优点，又有 EEPROM 电可擦除重写的特性。比一般标准的 EEPROM 快得多，具备 RAM 功能。

### 主存储器与 CPU 的连接
#### 存储器容量的扩展
1. 位扩展：增加存储字长。如利用2片 1K * 4 位的存储芯片组成 1K * 8 位的存储器。
2. 字扩展：增加存储字的数量。如利用2片 1K * 8 位的存储芯片组成 2K * 8 位的存储器。
3. 字、位扩展：既增加存储字的数量，又增加存储字长。如利用8片 1K * 4 位的存储芯片组成 4K * 8 位的存储器。

#### 存储器与 CPU 的连接
1. 地址线的连接：CPU 的地址线数往往比存储芯片多，通常将 CPU 地址线的低位与存储芯片的地址线相连，CPU 地址线的高位可作片选信号等。
2. 数据线的连接：CPU 的数据线数比存储芯片多时，必须对存储芯片扩位。
3. 读/写命令线的连接：读/写控制线可以分开也可以合并。
4. 片选线的连接：当 CPU 的地址线比存储芯片多时，需要将多出的高位与 CPU 的片选线进行逻辑运算处理后连接。

### 双口 RAM 和多模块存储器
* 双口 RAM 是指一个 RAM 有两套独立的数据线、地址线和控制线。
* 多模块存储器可分为高位交叉和低位交叉。
    * 高位交叉：顺序编址，有利于存储器的扩充。
    * 低位交叉：低位地址表示体号，各个体轮流编址，可在不改变存取周期的前提下增加存储器带宽。

### 高速缓冲存储器（Cache）
主存速度的提高跟不上 CPU 的发展，希望由高速缓存解决主存与 CPU 的速度不匹配的问题。  
利用了程序访问的**局部性原理**：
* 时间局部性：刚被访问过的单元很可能**不久**又被访问。
* 空间局部性：刚被访问过的单元的**邻近**单元很可能被访问。

#### Cache 的基本工作原理
* 将主存和缓存各分为若干块，每块包含若干个字，并使它们块大小相同，即块内字数相同。则可将主存地址和缓存地址都分为两段：主存中高 m 位表示主存的块地址，低 b 位表示块内地址；缓存中高 c 位表示缓存的块地址，低 b 位表示缓存的块内地址。  
* CPU 想要访问某地址时，经**主存 Cache地址映射变换机构**将主存地址转换为 Cache 地址，然后检查 Cache 内是否有该地址所在的块，若有则称为命中，可直接读取返回；若没有则称为不命中，若不命中且 Cache 已满，则需经过 **Cache 替换机构**将 Cache 中的某些块替换为所需要的主存块。  
* 通常用“命中率”来衡量 Cache 的效率，设 $N_c$ 为访问 Cache 的总命中次数， $N_m$ 为 Cache 未命中而需访问主存的总次数，则命中率 $h=\frac{N_c}{N_c + N_m}$。设 $t_c$ 为命中时 Cache 的访问时间， $t_m$ 为未命中时主存的访问时间，则访问效率 $e=\frac{t_c}{ht_c + (1-h)t_m}$。

#### Cache 和主存之间的映射方式
##### 直接映射
每个主存块只能对应一个缓存块，每个缓存块可以对应多个主存块。  
用 $i$ 表示缓存块号，$j$ 表示主存块号，$C$ 表示缓存块数，则有 $i=j\mod C$。  
实现简单但不够灵活。

##### 全相联映射
主存中的任一块可以映射到缓存中的任一块。  
足够灵活，命中率高；但访问一次需比较所有 Cache 地址，所需逻辑电路甚多，成本较高。

##### 组相联映射
是直接映射和全相联映射的一种折中，把 Cache 分为 Q 组，每组 R 块，又称为 R 路组相联（如二路组相联）。  
有 $i=j\mod Q$，设 Cache 有16组，每组2块，则主存的第0，16，32…块可以映射到 Cache 第0组两块中的任意一块。

#### Cache 中主存块的替换算法
* 先进先出（FIFO）算法：没有利用访存的局部性原理，不能提高 Cache 的命中率。
* 近期最少使用（Least Recently Used, LRU）算法：平均命中率比 FIFO 高。一般采用简化的方法，记录每个块最近一次使用的时间。

#### Cache 写策略
* 写直达（Write-through）：写操作时数据既写入 Cache 又写入主存，所需时间为访问主存的时间。可以保证主存和 Cache 始终一致，但增加了访存次数。
* 写回（Write-back）：写操作时只写入 Cache 不写入主存，所需时间为访问 Cache 的时间。在 Cache 被替换出去时才写入主存，增加了 Cache 的复杂性。

### 虚拟存储器
#### 虚拟存储器的基本概念
能使计算机有外存的容量，接近于主存的速度和外存的位成本，使程序员可以按比主存大得多的空间来编制程序，即按虚存空间编址。

#### 页式虚拟存储器
* 把虚拟空间分成页，称为逻辑页；把内存空间也分成同样大小的页，称为物理页。两种页的大小相等，所以页内地址是相等的。  
* 虚存地址到主存地址的变换是由放在主存的页表来实现的。页表中每一个虚存逻辑页号都对应该逻辑页所在的主存页面地址、有效位、修改位及其它控制位。在访存时需先查询页表，找到该逻辑页对应的物理地址，若有效位为0，说明该页尚未填入主存，需要调用输入输出系统从外存中读取该页再继续访问；若有效位为1，则可直接进行访问。
* 上述过程中发现每次访存都至少需要两个正常访存时间，故引入转译后备缓冲区（Translation Lookaside Buffer, TLB），即为页表的 Cache，比内存速度快，可减少查询页表的时间。

#### 段式虚拟存储器
段是按照程序的逻辑结构划分的，各个段的长度因程序而异。  
虚存地址到主存地址的变换是由放在主存的段表来实现的。段表与页表类似，增加了该段的长度指示。在访问该段时，如果段内地址超过段的长度，则发生中断。

#### 段页式虚拟存储器
是段式和页式的结合。把程序按逻辑单位分段以后，再把每段分成固定大小的页。  
对主存的调入调出是按页进行的，但又可以按段实现共享和保护。缺点是在地址映像过程中需要多次查表。