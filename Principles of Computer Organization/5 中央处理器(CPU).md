## 中央处理器(CPU)
**掌握 CPU 的功能、基本组成和各个部分的工作流程，了解微程序控制器的基本工作原理，了解微程序控制技术和硬布线控制技术，了解流水 CPU 的工作原理及特点。**

### CPU 的功能和组成
CPU 包含控制器和运算器，控制器的功能有：取指令、分析指令、执行指令、控制程序输入及结果输出、总线管理及处理异常情况和特殊请求。运算器的功能有实现算术运算和逻辑运算。  
要取指，需要有程序计数器 PC；要译码，需要有指令寄存器 IR 及译码部件；要执行，需要有控制单元 CU；要完成算逻运算，需要有寄存器和 ALU；要处理异常情况，需要有中断系统。

### 指令执行过程
CPU 取出并执行一条指令所需的全部时间称为指令周期。
* 取指周期：取指阶段完成取指令和分析指令的操作
* 执行周期：执行阶段完成执行指令的操作

由于不同指令所需的执行时间不同，如 NOP 指令不需要执行、乘法指令执行时间远大于加法指令等，不同指令的指令周期也是不同的。
* 间址周期：对于有间接寻址的指令。
* 中断周期：当 CPU 采用中断方式实现主机与 I/O 设备交换信息时，CPU 在每条指令执行阶段结束前，都要发中断查询信号，以检测是否有某个 I/O 设备提出中断请求。

### 数据通路
#### 功能
进行数据存储、处理、转送。  
* 取指周期数据流：PC 赋给存储器地址寄存器（MAR），MAR 传至地址总线，CU 向控制总线发信号，存储器接收控制总线的命令和地址总线的地址并将数据传至数据总线，存储器数据寄存器（MDR）接受数据总线上的数据，MDR 赋给 IR，CU 控制 PC加1。
* 间址周期数据流：MDR 赋给 MAR，MAR 传至地址总线，CU 向控制总线发信号，存储器接收命令和地址并将数据传至数据总线，MDR 接受数据总线上的数据。
* 中断周期数据流：CU 给 MAR 赋值，MAR 传至地址总线，CU 向控制总线发信号，PC 赋给 MDR，存储器接收命令、地址和数据并写入，CU 更改 PC。

#### 基本结构
由组合逻辑元件和存储元件两类部件组成。

### 控制器
#### 硬布线控制器
##### 功能
硬布线控制器又称组合逻辑控制器，把控制部件看作产生专门固定时序控制信号的逻辑电路。

##### 工作原理
某一微操作控制信号是指令操作码译码器输出、时序信号和状态条件信号的函数，这个函数是通过门电路、触发器等许多器件采用组合逻辑设计方法来实现的。

#### 微程序控制器
##### 功能
利用软件方法来设计硬件。

##### 工作原理
把操作控制信号编成“微指令”，存放到一个只读存储器里。当机器运行时，一条又一条地读出这些微指令，从而产生全机所需要的各种操作控制信号，使相应部件执行所规定的操作。

### 指令流水线
#### 基本概念
* 系统的并行性通常分为四个等级：作业级或程序级、任务级或进程级、指令之间级和指令内部级。前两级为粗粒度，一般用软件算法实现；后两级为细粒度，一般用硬件实现。  
* 指令流水类似于工厂的装配线，装配线利用了产品在装配的不同阶段其装配过程不同这一特点，使每个装配段对不同产品同时加工。将工厂流水线的思想引用到指令的执行上，就引出了指令流水的概念。
* 判断流水线性能：
    * 吞吐率（Throughput Rate）：单位时间内流水线所完成指令或输出结果的数量。设 $m$ 段的流水线各段时间为 $\Delta t$。
        * 最大吞吐率：连续流动达到稳定状态后获得的吞吐率。 $T_{pmax}=\frac{1}{\Delta t}$。
        * 实际吞吐率：完成 n 条指令的实际吞吐率。 $T_p=\frac{n}{m\Delta t+(n-1)\Delta t}$。
    * 加速比（Speedup Ratio）：m 段流水线的速度与等功能非流水线速度之比。
    * 效率（Efficiency）：流水线各段处于工作时间的时空区与流水线中各段总的时空区之比。

#### 基本实现
若将指令的处理分为六个阶段：取指（FI），译码（DI），计算操作数地址（CO），取操作数（FO），执行指令（EI），写操作数（WO）。则六级流水可表示为：

| 时间单元 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 | 13 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 指令1 | FI | DI | CO | FO | EI | WO |  |  |  |  |  |  |  |
| 指令2 |  | FI | DI | CO | FO | EI | WO |  |  |  |  |  |  |
| 指令3 |  |  | FI | DI | CO | FO | EI | WO |  |  |  |  |  |
| 指令4 |  |  |  | FI | DI | CO | FO | EI | WO |  |  |  |  |
| 指令5 |  |  |  |  | FI | DI | CO | FO | EI | WO |  |  |  |
| 指令6 |  |  |  |  |  | FI | DI | CO | FO | EI | WO |  |  |
| 指令7 |  |  |  |  |  |  | FI | DI | CO | FO | EI | WO |  |
| 指令8 |  |  |  |  |  |  |  | FI | DI | CO | FO | EI | WO |

完成一条指令需6个时间单位，若串行执行共需48个时间单位，六级流水共用了13个时间单位。  
但是现实中几乎不存在这么理想化的流水线，有三个影响流水线性能的因素：
* 结构相关：在指令重叠执行的过程中，不同指令争用同一功能部件产生资源冲突。如主存只有一个读通道时，上述表格中指令1的 FO 与指令4的 FI 会争用读通道。
    解决办法有停顿（阻塞），指令存储器和数据存储器分开，指令预取技术。
* 数据相关：流水线中的各条指令因重叠操作，可能改变对操作数的读写访问顺序。
    * 写后读相关（Read After Write, RAW）：发生在循序运行与乱序执行流水线中。
    * 读后写相关（Write After Read, WAR）：只可能发生在乱序执行流水线中。
    * 写后写相关（Write After Write, WAW）：只可能发生在乱序执行流水线中。
    解决办法有后推法（阻塞），旁路技术。
* 控制相关：由转移指令引起。

#### 超标量和动态流水线的基本概念
* 超标量技术：在每个时钟周期内可同时并发多条独立指令，即以并行操作方式将两条或两条以上指令编译或执行。需要通过编译优化技术把可并行执行的指令搭配起来。
* 动态调度技术：乱序执行。

### RISC CPU
