## 输入输出(I/O)系统
**了解 I/O 系统基本概念、I/O 接口的工作原理和特点，理解程序查询方式、程序中断方式和 DMA 方式工作原理。**

### I/O 系统基本概念
#### 发展概况
* 早期阶段：I/O 设备与主存交换信息都必须经过 CPU，每个 I/O 设备都必须配有一套独立的逻辑电路与 CPU 相连，I/O 设备与 CPU 按串行方式工作。
* 接口模块和 DMA 阶段：I/O 设备通过接口模块与主机连接，计算机采用总线结构。接口使 I/O 设备与 CPU 可按并行方式工作，I/O 设备之间也可实现并行工作
* 具有通道结构的阶段：通道是从属于 CPU 的一个专用处理器。
* 具有 I/O 处理机的阶段。

#### 组成
* I/O 软件：I/O 指令、通道指令
* I/O 硬件：接口模块、I/O 设备

#### 与主机联系方式
* 设备寻址：由 I/O 指令的设备码字段直接指出设备号，通过接口电路中的设备选择电路选中要交换信息的设备。
* 传送方式：串行、并行。
* 联络方式：
    * 立即响应方式：对于慢速 I/O，与 CPU 发生联系时已处于等待状态。
    * 异步工作采用应答信号联络：I/O 设备与主机工作速度不匹配。I/O 设备与 CPU 各自完成自身的任务，一旦出现联络信号，彼此才准备交换信息。
    * 同步工作采用同步时标联络：I/O 设备与 CPU 的工作完全同步。

### 外部设备
大致分三类：人机交互设备、计算机信息的存储设备、机 - 机通信设备（调制解调器等）

#### 输入设备
* 键盘：按下一个键 -> 查出按下的是哪个键 -> 将此键翻译成 ASCII 码由计算机接收
* 鼠标：机械式（底座有金属球，与四个方向的电位器接触）、光电式（利用光电转换器）

#### 输出设备
* 显示器：字符显示、图形显示、图像显示
* 打印机：击打式、非击打式

#### 外存储器
硬盘存储器、磁盘阵列、光盘存储器

### I/O 接口(I/O 控制器)
#### I/O 接口的功能
* 选址功能：设备选择电路
* 传送命令的功能：命令寄存器、命令译码器
* 传送数据的功能：数据缓冲寄存器
* 反映 I/O 设备工作状态的功能：状态标志触发器

#### I/O 接口的基本结构
上述功能中的结构再加上控制逻辑电路。

#### I/O 端口及其编址
* 统一编址：将 I/O 地址看作存储器地址的一部分，使用访存指令。
* 不统一编址：I/O 地址和存储器地址分开，专用 I/O 指令。

### I/O 方式
#### 程序查询方式
* CPU 通过程序不断查询 I/O 设备是否已做好准备，从而控制 I/O 设备与主机交换信息。
* 按 I/O 设备在系统中的优先级进行逐级查询。对每个 I/O 设备，检查其状态标志，若准备就绪，则进行处理，否则检查下一优先级的设备。
* 开始处理某设备时，需要将处理程序插入到现行程序中。先保存上下文，然后设置需要交换数据的计数器和在主存缓冲区中的首地址；CPU 启动 I/O 设备，根据设备标志状态判断是否准备就绪，未就绪则等待；就绪后便执行 I/O 指令传送一个数据，然后修改主存地址，修改计数值，判断计数值是否为0，即是否传送完。

#### 程序中断方式
* 在设备准备的同时，CPU 继续执行现行程序，只有当 I/O 设备准备就绪向 CPU 提出请求后，再暂时中断 CPU 现行程序转入 I/O 服务程序。
* 需要在接口处配置中断请求触发器、中断屏蔽触发器、排队器、中断向量地址形成部件。
* CPU 是在统一的时刻（每条指令执行阶段结束前）向接口发中断查询信号，以获取 I/O 中断请求。处理过程为：CPU 发启动 I/O 设备命令，接口启动输入设备工作；输入设备将数据送入数据缓冲寄存器（DBR），输入设备向接口发“设备工作结束”信号；设备准备就绪且本设备未被屏蔽，在 CPU 发出中断查询信号时，标志设备向 CPU 提出**中断请求**，并送至排队器进行**中断判优**；若 CPU 允许中断，设备又被选中，进入**中断响应**阶段，编码器形成向量地址，向量地址送至 PC 作为下一条指令的地址。
* 中断服务程序的流程：保护现场，中断服务，恢复现场，中断返回。
* 单重中断：不允许中断现行的中断服务程序。多重中断：允许级别更高的中断源中断现行的中断服务程序。

#### DMA 方式
* DMA 与主存交换数据时采用如下三种方法：
    * 停止 CPU 访问主存：CPU 放弃地址线、数据线和有关控制线的使用权。  
        控制简单。CPU 处于不工作状态或保持原状态，未充分发挥 CPU 对主存的利用率。
    * 周期挪用（或周期窃取）：每当 I/O 设备发出 DMA 请求时，便挪用或窃取总线占用权一个或几个主存周期。会遇到三种情况：CPU 不访存，CPU正在访存（待 CPU 存取周期结束），CPU 同时请求访存（I/O 优先级高）。  
        既实现了 I/O 传送，又较好地发挥了主存与 CPU 的效率，被广泛采用。
    * DMA 与 CPU 交替访问：可将一个 CPU 周期分为两个分周期，第一个专供 DMA 访存，第二个专供 CPU 访存。  
        不需要申请建立和归还总线的使用权。硬件逻辑复杂。
* DMA 接口的功能：向 CPU 申请 DMA 传送，处理总线控制权的转交，管理系统总线、控制数据传送，确定数据传送的首地址和长度、修正传送过程中的数据地址和长度，给出操作完成信号。
* DMA 接口基本组成：主存地址寄存器（AR），字计数器（WC），数据缓冲寄存器（BR），DMA 控制逻辑，中断机构，设备地址寄存器（DAR）。
* 传送过程：
    * 预处理：预置数据传送方向，向 DAR 送入设备号，向 AR 送入主存起始地址，向 WC 送入交换数据的个数。
    * 数据传送：DMA 接口向 CPU 申请总线控制权，CPU 发回信号表示同意；将 DMA AR 中的地址送入地址总线，通知设备已被授予一个周期、为交换下一个字做准备，数据（BR 或主存中）送至数据总线；修改主存地址和 WC 值，结束则向 CPU 申请中断。
    * 后处理：CPU 停止原程序，执行中断服务程序，包括校验送入主存的数据是否正确，决定是否继续使用 DMA，测试传送过程中是否发生错误。

#### 通道方式
* 通道的基本功能是执行通道指令、组织外围设备和内存进行数据传输、按 I/O 指令要求启动外围设备，向 CPU 报告中断等。
* 通道分为选择通道、数组多路通道、字节多路通道。