## 设备管理和磁盘调度
**理解输入输出设备及操作系统中输入/输出功能的组织、掌握中断处理、设备驱动程序、设备无关的软件接口和 spooling 等技术，重点掌握各种用于提高性能的缓冲策略和磁盘调度算法；了解可提高性能和可靠性的各种磁盘阵列配置方式。**

### 操作系统中输入/输出功能的组织
通常把 I/O 软件组织成四个层次：
* 用户层 I/O 软件，实现与用户交互的接口。
* 设备独立性软件。
* 设备驱动程序。
* 中断处理程序。

下三层通常被称为 I/O 系统，它的上下有两个接口：
* 上面有 I/O 系统接口，是与用户层软件的接口。
* 下面有软件/硬件接口，它的下面是各种设备的控制器。

### 中断处理
中断处理程序的处理过程可分成以下几个步骤：
1. 测定是否有未响应的中断信号。
2. 保护被中断进程的 CPU 环境。通常由硬件自动将处理机状态字（PSW）和程序计数器（PC）保存在中断保留区（栈）中，然后把包括所有 CPU 寄存器的内容都压入中断栈中。
3. 转入相应的设备处理程序。
4. 中断处理。
5. 恢复 CPU 的现场并退出中断。

### 设备驱动程序
#### 设备驱动程序
* 主要任务是启动指定设备，完成上层制定的 I/O 工作。但在启动之前，应先完成必要的准备工作。
* 处理过程为：将抽象要求转换为具体要求（例如将盘块号转换为磁盘的扇面、磁道号及扇区），对服务请求进行校验，检查设备的状态，传送必要的参数，启动 I/O 设备。
* 对 I/O 设备的控制有轮询、中断和 DMA 三种方式。

#### 设备无关的软件接口
为了实现设备独立性，必须在设备驱动程序之上设置一层软件，称为设备独立性软件，这是 I/O 系统的最高层软件。在与设备无关的软件中，至少应有如下几个接口：
* 设备驱动程序的统一接口：一方面要求每个设备驱动程序与 OS 之间都有着相同或相近的接口；另一方面要将抽象的设备名映射到适当的驱动程序上。
* 缓冲管理：I/O 设备的运行速度都远低于 CPU 的速度，所以需要配置缓冲区。
* 差错控制：设备中有许多机械和电气部分，因此比主机更容易出现故障。错误可分为暂时性错误（如电源波动，可以通过重试操作来纠正）和持久性错误（持久性故障引起，如电源掉电）。
* 对独立设备的分配与回收：系统中有两类设备：独占设备和共享设备。为了避免进程对独占设备的争夺，必须提出申请后由系统来统一分配。
* 独立于设备的逻辑数据块：不同类型的设备数据交换单位、读取传输速率都不同。软件应能隐藏这些差异，向高层提供大小统一的逻辑数据块。

还有两个表：
* 设备控制表 DCT：用于记录设备的情况。表中有指示设备类型的字段 type，设备标识字段 deviceid，设备队列队首指针，忙/闲标志等。
* 逻辑设备表 LUT：用于将逻辑设备名映射为物理设备名。表中有三项：逻辑设备名、物理设备名和设备驱动程序的入口地址。

#### SPOOLing 技术
当系统中引入多道程序技术后，可以利用其中的一道程序，把低速 I/O 设备上的数据传送到高速磁盘上；或是用另一道程序把数据从磁盘传送到低速输出设备上。这样就可以在主机的直接控制下，实现以前的脱机输入、输出功能。此时的外围操作与 CPU 对数据的处理同时进行，把这种技术称为 SPOOLing 技术，或假脱机技术。  
SPOOLing 系统由四部分构成：
* 输入井和输出井：在磁盘上开辟出来的两个存储区域。
* 输入缓冲区和输出缓冲区：在内存中开辟的两个缓冲区，用于缓和 CPU 和磁盘之间速度不匹配的矛盾。
* 输入进程和输出进程。
* 井管理程序。

### 缓冲策略
引入缓冲区的原因可归结为：缓和 CPU 与 I/O 设备间速度不匹配的矛盾；减少对 CPU 的中断频率，放宽对 CPU 中断响应时间的限制；解决数据粒度不匹配的问题；提高 CPU 和 I/O 设备之间的并行性。
* 单缓冲区：每当用户发出一 I/O 请求时，操作系统便在主存中为之分配一缓冲区。必须互斥使用。
* 双缓冲区：在设备输入时，先将数据送入第一缓冲区，装满后便转向第二缓冲区。此时操作系统就可以从第一缓冲区中移出数据并进行计算。
* 环形缓冲区：在环形缓冲中包括多个缓冲区，每个缓冲区的大小相同。作为输入的多缓冲区可分为三种类型：用于装输入数据的空缓冲区 R、已装满数据的缓冲区 G 以及计算进程正在使用的现行工作缓冲区 C。
	* Getbuf 过程：当计算进程要使用缓冲区中的数据时，可调用 Getbuf 过程。
	* Releasebuf 过程：当计算进程把 C 缓冲区中的数据提取完毕时，便调用 Releasebuf 过程，将缓冲区 C 释放。
* 缓冲池：包含一个管理的数据结构以及一组操作函数的管理机制，用于管理多个缓冲区。可形成三个队列：空白缓冲队列 emq、输入队列 inq 和输出队列 outq。

### 磁盘调度算法
磁盘耗时包括：寻道时间、旋转延迟和数据传输时间。

#### 先到先服务（FCFS）
* 好处：公平性；服务顺序是应用预期的。
* 坏处：请求到来是随机的，要经常长距离寻道；可能会发生极端情况，比如横扫整个磁盘。

#### 最短寻找优先（Shortest Seek First，SSF）
选择离当前磁头所在磁道最近的磁道。
* 好处：可减少寻道时间。
* 坏处：可能产生饥饿。

#### 扫描（SCAN）
也称为**电梯调度**。磁头按一个方向到另一端，再折回，不断往返；每次只服务当前移动方向上寻道距离最近的请求；如果磁盘移动方向上没有请求，就折回。
* 好处：消除饥饿，请求的服务时间有上限。
* 坏处：反方向的请求需要等待更长时间；访问局部性方面不如上两个算法。

#### C-SCAN
在扫描算法的基础上规定磁头单向移动来提供服务，回返时直接快速移动到起始端，不服务任何请求；类似将两端点连起来成环。
* 好处：服务时间趋于一致。
* 坏处：折回时不提供服务。

### 磁盘阵列
独立磁盘冗余阵列（Redundant Array of Independent Disks, RAID）主要思想是由多个磁盘构成一个存储设备。要考虑块映射机制和冗余机制。  
好处：提高性能（可并行工作），增加容量，提高可靠性（数据冗余）。  
坏处：成本较高，控制器较复杂。
* RAID-0：以条带为粒度映射到 N 块磁盘，无冗余。

|Disk0 | Disk1 | Disk2 | Disk3 |
| :--: | :--: | :--: | :--: |
| Strip0 | Strip1 | Strip2 | Strip3 |
| Strip4 | Strip5 | Strip6 | Strip7 |
| Strip8 | Strip9 | Strip10 | Strip11 |
* RAID-1：采用镜像冗余。

|Disk0 | Disk1 | Disk2 | Disk3 |
| :--: | :--: | :--: | :--: |
| Strip0 | Strip1 | Strip0 | Strip1 |
| Strip2 | Strip3 | Strip2 | Strip3 |
| Strip4 | Strip5 | Strip4 | Strip5 |
* RAID-4：条带化+1个校验块，所有校验块都放在同一块磁盘上，使用异或计算。校验盘易坏，且为写性能瓶颈。

|Disk0 | Disk1 | Disk2 | Disk3 | Disk4 |
| :--: | :--: | :--: | :--: | :--: |
| Strip0 | Strip1 | Strip2 | Strip3 | P0-3 |
| Strip4 | Strip5 | Strip6 | Strip7 | P4-7 |
| Strip8 | Strip9 | Strip10 | Strip11 | P8-11 |
* RAID-5：条带化+1个校验块，校验块分散在不同磁盘上。

|Disk0 | Disk1 | Disk2 | Disk3 | Disk4 |
| :--: | :--: | :--: | :--: | :--: |
| Strip0 | Strip1 | Strip2 | Strip3 | P0-3 |
| Strip4 | Strip5 | Strip6 | P4-7 | Strip7 |
| Strip8 | Strip9 | P8-11 | Strip10 | Strip11 |