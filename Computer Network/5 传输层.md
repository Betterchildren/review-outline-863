## 传输层
### 传输层提供的服务
#### 传输层的功能
* 传输层位于网络层之上，为运行在不同主机上的进程之间提供了逻辑通信，而网络层提供了主机之间的逻辑通信。
* 复用和分用。复用指发送方不同的应用进程都可以使用同一个传输层协议传送数据，分用指接收方的传输层在剥去报文的首部后能够把这些数据正确交付到目的应用进程。
* 传输层还要对收到的报文进行差错检测，包括数据部分。
* 提供两种不同的传输协议，即面向连接的 TCP 和无连接的 UDP。采用 TCP 时，应用进程看到的是一条全双工的可靠信道；采用 UDP 时，这种逻辑通信信道仍然是一条不可靠信道。

#### 传输层寻址与端口
* 端口能够让应用层的各种应用进程将其数据通过端口向下交付给传输层，以及让传输层知道应当将其报文段中的数据向上通过端口交付给应用层相应的进程。端口标识了主机中的应用进程，端口号只具有本地意义。
* 端口号长度为16位，根据端口号范围可分为两类：
	* 服务端使用的端口号：这里又分两类，最重要的一类是熟知端口号，数值为0\~1023，被 IANA（互联网地址指派机构）分配给 TCP/IP 一些最重要的应用程序；另一类是登记端口号，数值为1024\~49151，使用时必须在 IANA 登记。
	* 客户端使用的端口号：数值为49152\~65535，又叫短暂端口号或临时端口。客户进程通信结束后就可以给其它客户进程使用。
* 套接字（Socket）=（主机 IP 地址，端口号）。

#### 无连接服务与面向连接服务
* TCP 提供面向连接的服务，在通信之前必须先建立连接，数据传送结束后释放连接。会增加许多开销，会使协议数据单元头部增大，也会占用处理机资源，适用于 FTP，HTTP 等。
* UDP 提供无连接服务，直接将信息发送到网络中，尽力向目的地传送。执行速度快，实时性好，适用于 DNS 等。

### UDP 协议
#### UDP 数据报
* UDP 提供尽最大努力的交付，即不保证可靠交付，所有维护传输可靠性的工作需要在应用层完成。UDP 是面向报文的。
* UDP 数据报包含 UDP 首部和用户数据。首部有8个字节，由4个字段组成：源端口、目的端口、长度和校验和。校验和检测有错就丢弃，当源主机不想计算校验和时可全置0。

#### UDP 校验
计算校验和时，要在 UDP 数据报之前增加12个字节的伪首部，其中包括源 IP 地址、目的 IP 地址和 UDP 长度。UDP 校验时把首部部分和数据部分一起检验。

### TCP 协议
提供可靠的交付服务，保证传送的数据无差错、不丢失、不重复且有序。提供全双工通信。

#### TCP 段
首部的前20字节是固定的；首部最短为20字节，后面有4N字节是根据需要可增加的选项。
* 源端口和目的端口字段：各2字节。
* 序号字段：4字节。TCP 是面向字节流的，传送的数据流中的每个字节都有序号，该字段的值为本报文段所发送数据第一个字节的序号。
* 确认号字段：4字节。是期望收到对方的下一个报文段的数据的第一个字节的序号。
* 数据偏移（即首部长度）：4位。
* 紧急位 URG：有效时表明此报文段有紧急数据，应尽快传送。数据从第一个字节到紧急指针字段（16位）所指字节位紧急数据。
* 确认位 ACK：有效时确认号字段才有效。规定建立连接后所有的报文段都要把 ACK 置1。
* 推送位 PSH：有效时就尽快交付应用程序。
* 复位位 RST：有效时表明连接中出现严重差错，必须释放连接然后重新建立。
* 同步位 SYN：有效时表明这是连接请求或连接接收报文。
* 终止位 FIN：有效时表明发送方数据已发送完毕。
* 窗口字段：2字节。指出现在允许对方发送的数据量，单位为字节。
* 检验和：2字节。检验包括首部和数据，计算时要加12字节的伪首部。

#### TCP 连接管理
每个 TCP 连接都有三个阶段：连接建立、数据传送和连接释放。TCP 连接的两个端点是套接字。

##### 连接建立
1. 客户机的 TCP 首先向服务器的 TCP 发送一个连接请求报文段，其中不含应用层数据。首部的 SYN 被置为1，客户机会随机选择一个起始序号x。
2. 服务器的 TCP 收到请求报文段后，同意则为该连接分配 TCP 缓存和变量，并发回确认。确认报文段中 SYN 和 ACK 都被置为1，确认号字段值为x+1，随机产生一个起始序号值为y。
3. 客户机收到确认报文段后，分配缓存和变量，并发回确认。报文段的 ACK 置为1，序号字段为x+1，确认号字段为y+1。

##### 连接释放
1. 客户机打算关闭连接，就向 TCP 发送连接释放报文段，并停止再发送数据。报文段的 FIN 置1，序号字段为已传送过的数据的最后一个字节的序号加1。
2. 服务器收到连接释放报文段后发回确认。确认号字段为u+1，序号字段为已传送过的数据的最后一个字节的序号加1。此时，从客户机到服务器方向的连接就释放了，TCP 处于半关闭状态。
3. 若服务器也打算关闭连接，就发出 FIN 为1的连接释放报文段。
4. 客户机收到连接释放报文段后，必须发出确认。确认报文段中 ACK 置1，序号字段为u+1。

#### TCP 可靠传输
* TCP 首部的序号字段用来保证数据能有序提交给应用层，TCP 把数据看成有序的字节流，序号是建立在传送的字节流之上的。
* 确认号字段默认使用累计确认，即只确认数据流中至第一个丢失字节为止的字节。
* 有两种事件会导致 TCP 对报文段进行重传。
	* 超时：TCP 每发送一个报文段，就对这个报文段设置一个计时器，只要计时结束但还没收到确认，就重传这一报文段。TCP 会记录一个报文段发出的时间，以及收到相应确认的时间，时间差叫做报文段的往返时间（RTT），并保留一个加权 RTT 来计算要设置的重传时间。
	* 冗余 ACK：TCP 规定每当比期望序号大的失序报文段到达时，发送一个冗余 ACK，指明下一个期待字节的序号。并且当发送方收到对同一个报文段的3个冗余 ACK 时，就可以认为跟在这个被确认报文段之后的报文段已经丢失。这时要立刻重传，这种技术称为快速重传。

#### TCP 流量控制
流量控制是用来匹配发送方的发送速率和接收方的读取速率。在通信过程中，接收方动态地调整发送方的发送窗口大小，这就是接收窗口 rwnd，即调整首部中的窗口字段值。同时，发送方根据其对当前网络拥塞程度的估计而确定的窗口值称为拥塞窗口 cwnd。发送窗口的实际大小是取 rwnd 和cwnd 的最小值。

#### TCP 拥塞控制
拥塞控制是让网络能够承受现有的网络负荷，是一个全局性的过程。流量控制往往指点对点的通信量的控制。

##### 慢开始和拥塞避免
* 慢开始算法：先令拥塞窗口 cwnd=1，每收到一个对新的报文段的确认后，将 cwnd 加1。使用这种算法，每经过一个传输轮次，即 RTT，cwnd 就会加倍。一直增加到一个规定的慢开始门限 ssthresh，然后改用拥塞避免算法。
* 拥塞避免算法：cwnd 每经过一个 RTT 就增加1，使 cwnd 按线性规律缓慢增长，出现一次超时时，就令 ssthresh 等于当前 cwnd 的一半。
* 拥塞处理：无论在慢开始阶段还是拥塞避免阶段，只要发送方检测到超时事件，就把 ssthresh 设置为出现拥塞时 cwnd 的一半（不能小于2），然后把 cwnd 重新设置为1，执行慢开始算法。在慢开始阶段，若 2\*cwnd>ssthresh，则下一个 RTT 的 cwnd 应等于 ssthresh。

##### 快重传和快恢复
快重传和快恢复算法是对上述算法的改进。
* 快重传：使用冗余 ACK 来检测丢包的发生。并非取消重传计时器，而是在某些情况下能更早地重传丢失的报文段。
* 快恢复：发送端收到连续三个冗余 ACK 时，就把 ssthresh 和 cwnd 同时设置为出现拥塞时 cwnd 的一半，然后执行拥塞避免算法。
