## 网络层
### 网络层的功能
#### 异构网络互联
互联指将两个以上的计算机网络，用一种或多种通信处理设备（即中间设备）相互连接起来，以构成更大的网络系统。中间设备又称为中间系统或中继系统，根据其所在层次可以分为：
* 物理层：中继器、集线器
* 数据链路层：网桥、交换机
* 网络层：路由器
* 网络层以上：网关

#### 路由与转发
路由器主要完成两个功能：
* 路由选择：动态改变所选择的路由。
* 分组转发：将用户的 IP 数据报从合适的端口转发出去。

#### 拥塞控制
在通信子网中，由于出现过量分组而引起网络性能下降的现象称为拥塞。拥塞控制的方法有两种：
* 开环控制：在设计网络时事先将有关发生拥塞的因素考虑周到，力求网络在工作时不产生拥塞，是一种静态的预防方法。
* 闭环控制：采用监测网络系统去监视，并调整网络系统的运行，是一种动态的方法。

### 路由算法
#### 静态路由与动态路由
* 静态路由算法（又称为非自适应路由算法）：指由网络管理员手工配置的路由信息，网络状态改变时，需要手工修改路由表中相关的静态路由信息。
* 动态路由算法（又称为自适应路由算法）：路由表项是通过相互联接的路由器之间彼此交换信息，然后按照一定的算法优化出来的。

#### 距离-向量路由算法
典型如 RIP 算法。所有结点都定期将整个路由选择表传送给所有相邻结点，选择表包含：
* 每条路径的目的地
* 路径的代价（也称距离）

所有的结点也会监听从其它结点传入的信息，在
* 某条路由本地不存在
* 某条到达同一目的地的路由代价比本地储存的小

的情况下更新本地路由选择表。
#### 链路状态路由算法
典型如 OSPF 算法。要求每个参与该算法的结点都有完全的网络拓扑信息，每个结点执行两项任务：
* 主动测试所有相邻结点的状态
* 定期将状态传播给其它所有结点

每个链路状态报文到达时，路由结点就使用这些状态信息去更新自己的网络拓扑和状态“视野图”，若链路状态发生变化，就采用 Dijkstra 算法重新计算最短路径。

#### 层次路由
因特网将整个互联网划分为许多较小的自治系统，每个自治系统有权自主地决定本系统内应采用何种路由选择协议。因特网把路由选择协议划分为两大类：
* 一个自治系统内部所使用的称为内部网关协议（IGP），也称为域内路由选择，具体协议有 RIP 和 OSPF。
* 自治系统之间所使用的称为外部网关协议（EGP），也称为域间路由选择，具体协议有 BGP。

当使用层次路由时，OSPF 将一个自治系统再划分为若干个区域，每个路由器只需知道本区域内的细节。

### IPv4
#### IPv4 分组
##### 分组格式
一个 IP 分组由首部和数据两部分组成。IP 首部的部分重要字段含义如下：
* 版本：IP 协议的版本，目前广泛使用的为 4。
* 首部长度：占4位，最大值为60字节。最常使用20字节，即不使用任何选项。以**4个字节**为偏移单位。
* 总长度：占16位，首部和数据之和的长度，最大为65535字节。以**1个字节**为偏移单位。
* 标识：占16位，是一个计数器，每产生一个数据报就加1。
* 标志：占3位，最低位为 MF，MF=1 表示后面还有分片；MF=0 表示最后一个分片。中间一位是 DF，只有 DF=0 才允许分片。
* 片偏移：占13位，指出分片后，某片在原分组中的相对位置。以**8个字节**为偏移单位。
* 首部检验和：占16位，只校验分组的首部。
* 生存时间 TTL：占8位，数据报在网络中可通过的路由器的最大值。
* 协议：占8位，指出携带的数据使用何种协议。

##### IP 数据报分片
一个链路层数据报能承载的最大数据量称为最大传送单元（MTU）。当 IP 数据报的总长度大于链路 MTU 时，就需要将 IP 数据报中的数据分装在两个或更多个较小的 IP 数据报中，这些小的数据报叫做**片**。当一个路由器需要将一个数据报分片时，形成的每个片都具有原始数据报的**标识**。分片后，由于片偏移的单位为8字节，所以除了最后一个片外，其他所有片中的有效数据载荷都是8的倍数。

##### 网络层转发分组的流程
* 从数据报的首部提取目的主机的 IP 地址 D，得出目的网络地址为 N。
* 若网络 N 与此路由器直接相连，则把数据报直接交付目的主机 D，这就叫路由器的直接交付；否则是间接交付，执行下一条。
* 若路由表中有目的地址为 D 的特定主机路由（对特定目的主机指明一个特定的路由，通常是为了控制或测试网络，或出于安全考虑才采用的），则把数据报传送给路由表中所指明的下一跳路由器；否则执行下一条。
* 若路由表中有到达网络 N 的路由，则把数据报传送给路由表指明的下一跳路由器；否则继续执行。
* 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则继续执行。
* 报告转发分组出错。

#### IPv4 地址与 NAT
传统的 IP 地址分A、B、C、D、E五类，每一类都是由网络号和主机号两部分组成。其中主机号全为0表示本网络本身，主机号全为1表示本网络的广播地址。32位全为0表示本网络上的本主机，32位全为1等效本网络的广播地址。  
网络地址转换（NAT）是通过将专用网络地址转换为共用地址，从而隐藏了内部管理的 IP 地址，使整个内部网只需要一个全球 IP 地址就可以与因特网连通。NAT 路由器根据 NAT 转换表进行本地地址转与全球地址之间的互相转换，转换表中存放着{本地 IP 地址：端口}到{全球 IP 地址：端口}的映射。

#### 子网划分与子网掩码、CIDR
在 IP 地址中增加一个“子网号字段”，使两级 IP 地址变为三级 IP 地址，这种做法叫划分子网。从主机号借用若干个比特作为子网号，路由器收到 IP 数据报后，先按目的网络号和子网号找到目的子网。  
子网掩码是一个与 IP 地址相对应的32位二进制串，由一串1和跟随的一串0组成，其中1对应网络号和子网号。路由器在相互交换路由信息时，必须把自己所在网络的子网掩码告诉对方；路由表中的每一个条目，除了要给出目的网络地址和下一跳地址外，还需要同时给出该目的网络的子网掩码。  
无分类域间路由选择（CIDR）是在变长子网掩码的基础上提出的一种消除传统A、B、C类网络划分，并且可以在软件的支持下实现超网构造的一种 IP 地址的划分方法。IP 地址的无分类两级编址为：IP::={<网络前缀>，<主机号>}；将网络前缀都相同的连续的 IP 地址组成“CIDR 地址块“，一个地址块可以表示很多地址，这种地址的聚合称为路由聚合。路由表项由”网络前缀“和”下一跳地址“组成，在查找路由表时应当选择具有最长网络前缀的路由，称为**最长前缀匹配**。

#### ARP 协议、DHCP 协议与 ICMP 协议
IP 地址时网络层使用的地址，硬件地址是数据链路层使用的地址（如 MAC 地址）。寻址时，在路由器间通过 IP 地址寻找到目标网络后，改为在目标网络中通过 MAC 地址寻址。  
* 地址解析协议 ARP：完成 IP 地址到 MAC 地址的映射，工作在网络层。
* 动态主机配置协议 DHCP：给主机动态地分配 IP 地址，工作在应用层，基于 UDP。
* 网际控制报文协议 ICMP：允许主机或路由器报告差错和异常情况，是 IP 层协议。报文分两类：ICMP 差错报告报文和 ICMP 询问报文。两个常见应用是 ping 和 traceroute。

### IPv6 的主要特点，IPv6 地址
IPv6 地址有128位，首部长度必须是8字节的整数倍，传输路径中的路由器不能分片，采用身份验证和保密功能。  
IPv6 地址可以是单播、多播、任播三种基本类型之一。IPv4 向 IPv6 过渡可以采用双协议栈和隧道技术两种策略。

### 路由协议
#### 自治系统
自治系统（AS）：在单一的技术管理下的一组路由器。

#### 域内路由与域间路由
* 内部网关协议（IGP）：在一个自治系统内部使用的路由选择协议。
* 外部网关协议（EGP）：将数据报从一个自治系统传递到另一个自治系统之中所需要的路由选择协议。

#### RIP 路由协议
路由信息协议（RIP）是 IGP 中最先得到广泛应用的协议，是应用层协议，使用 UDP 传送数据。每个路由器维护从它自己到每一个目的网络的距离记录，称“距离向量”；优先选择跳数少的路径；为了防止不断循环，允许一条路径最多只能包含15个路由器，16跳时即表示网络不可达。
* 特点：仅和相邻路由器交换信息；路由器之间交换本路由器所知道的全部信息；按固定的时间间隔交换路由信息。
* 距离向量算法：每一个路由表项都有三个关键数据：<目的网络 N，距离 d，下一跳路由器 X>，对于每个相邻路由器发送过来的 RIP 报文，进行：
	1. 对地址为 X 的相邻路由器发来的 RIP 报文，先把下一跳字段都改为 X，并把距离都加1。
	2. 当原来的路由表中没有目的网络 N 时，把该表项加到路由表中。
	3. 当原来的路由表中有目的网络 N，且下一跳路由器地址是 X 时，用收到的项目替换原路由表中的项目。
	4. 当原来的路由表中有目的网络 N，且下一跳路由器地址不是 X 时，若收到的表项中的 d 小于原表项中的，则替换。
	5. 如果180秒还没有收到相邻路由器的更新路由表，则把此相邻路由器距离设为16。

#### OSPF 路由协议
开放最短路径优先（OSPF）协议是 IGP 中的一种，是分布式链路状态路由算法的典型代表。  
* 与 RIP 区别：向本自治系统所有路由器发送信息，采用洪泛法；发送的信息只有与本路由器相邻的路由器以及该链路的代价；只有当链路状态发生变化时，才向所有路由器发送此信息；是网络层协议，直接 IP 数据报传送。
* 基本工作原理：所有路由器最终能建立一个链路状态数据库，即全网的拓扑结构图。每个路由器根据该结构图，使用 Dijkstra 最短路算法计算自己到各自网络的最优路径，将下一跳路由器存到路由表中。
* 五种分组类型：问候分组、数据库描述分组、链路状态请求分组、链路状态更新分组、链路状态确认分组。

#### BGP 路由协议
边界网关协议（BGP）是 EGP 中的一种，采用路径向量路由选择协议，是应用层协议，基于 TCP。
* 工作原理：每个自治系统选择至少一个路由器作为该系统的“BGP 发言人”。两个自治系统的发言人之间要交换路由信息，就要先建立 TCP 连接。当所有 BGP 发言人都相互交换网络可达性的信息后，就可找出到达各个自治系统的比较好的路由。
* 四种报文：打开报文、更新报文、保活报文、通知报文。

### 组播的概念，IP 组播地址
人们需要的组播机制是让源计算机一次发送的单个分组可以抵达用一个组地址标识的若干台目标主机。组播仅应用于 UDP。主机使用 IGMP 协议加入组播组。  
IP 组播使用 D 类地址格式，范围是224.0.0.0~239.255.255.255，每一个地址标志一个组播组，也并非所有 D 类地址都可作为组播地址。组播地址只能用于目的地址，而不能用于源地址。

### 移动 IP 的概念，移动 IP 的通信过程
移动 IP 技术是移动结点以固定的网络 IP 地址，实现跨越不同网段的漫游功能，并保证了基于 IP 的网络权限在漫游过程中不发生任何改变。基于 IPv4 的移动 IP 定义三种功能实体：移动结点、归属代理（也叫本地代理）和外埠代理（也叫外部代理）。  
移动 IP 技术的基本通信流程如下：
1. 移动结点在本地网时，按传统的方式通信（在本地网固有的地址）。
2. 移动结点漫游到一个外地网络时，仍然使用固定的 IP 地址进行通信。移动结点需要向本地代理注册当前的位置地址，即转交地址（可以是外部代理的地址或动态配置的一个地址）。
3. 本地代理接收注册后，会构建一条通向转交地址的隧道，将截获的发给移动结点的 IP 分组通过隧道送到转交地址处。
4. 在转交地址处解除隧道封装，恢复出原始的 IP 分组，最后送到移动结点。
5. 移动结点在外网通过外网的路由器或者外代理向通信对端发送 IP 数据包。

### 路由器的功能和组成，路由表与路由转发
路由器具有多个输入输出端口，任务是连接不同的网络并完成路由转发。从结构上看，路由器由路由选择和分组转发两部分构成。  
路由表是根据路由选择算法得出的，主要用途是路由选择，包含：目的网络 IP 地址、子网掩码、下一跳 IP 地址、接口。  
转发表是从路由表得出的，但格式不同，结构应使查找过程最优化，包含：目的地址、下一跳地址（实际为 MAC 地址）。
